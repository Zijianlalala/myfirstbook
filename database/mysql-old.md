# MySQL相关内容
## 博客
![Innodb中的事务隔离级别和锁的关系](https://tech.meituan.com/2014/08/20/innodb-lock.html)

![一条更新语句在MySQL是怎么执行的](https://gsmtoday.github.io/2019/02/08/how-update-executes-in-mysql/)


## 存储单位——页
结构
1. 页头
2. 用户数据区域
3. 页目：方便查找用户数据区域中的数据

页目录是用户数据区域的目录，包括
1. 主键值
2. 数据所在的地址

当数据增多，页也会增多，页会形成链表。查找数据时，需要从第一页的页目录中查找，效率降低。444444444444444444444所以用空间换时间，将这些页构造一个目录。
## Innodb

### 行格式

### 页格式

## 索引
> 索引是关系数据库中对某一列或多个列的值进行预排序的数据结构。通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度。

“索引就是目录”

主键索引又称为聚集索引。

搜索数据通过叶子节点从左到右扫描称为**全表扫描**。从根结点找，称为**走索引**。


### 底层实现
**B+树**，特点 
1. 有序
2. 一个节点有多个元素
3. 叶子节点相连，且与非叶子节点冗余。
4. 在MySQL中的每个页就是B+树的叶子节点，也就是数据页。其他非叶子节点就是索引页。
   

### 分类
1. 主键索引
2. 联合索引。叶子节点存放的是主键，再从主键索引中找到具体数据。遵守**最左前缀**原则

## Buffer Pool
1. free链表：管理空闲页。
2. flush链表：管理脏页。
3. LRU链表：管理待替换的页。

为了避免获取表的所有数据操作后，导致缓冲池中的热数据消失，对LRU链表做出了优化。将LRU链表分为两个区域：
1. 热数据区（占5/8）
2. 冷数据区（占3/8）

优先淘汰冷数据区中的数据。如果存入链表时的时间-再次访问的时间>1s时，将该控制块放到热数据区。

## 事务
在内存中完成修改后，还没来得及写进磁盘，这时候mysql挂掉了该怎么办。用到了
1. **redo log**：操作所对应的日志。记录的是某一页的某个修改的数据的位置。（innodb)
2. **bin log**：记录的是语句。主从复制。
3. **undo log**：保证原子性。反向操作的日志，用于回滚操作。实现事务隔离级别

update->修改buffer pool中的页数据->形成脏页->生成redo log（日志对象）放到log buffer中->把redo log持久化->返回给客户端结果

### redo log
有两个文件`ib_logfile0`和`ib_logfile1`。重复循环利用这两个文件。当两个文件都满时，将日志文件中对应的页持久化到磁盘中。

```
begin;
update ... -- 先将redo log存到log buffer中
commit;
-- 当事务提交的时候，才进行持久化
```

### 特性
ACID
1. 原子性Atomicity
2. 隔离性Isolation
3. 一致性Consistency
4. 持久性Durability

#### 隔离性
事务是自动提交`autocommit`。写`update`的时候会自动的开启一个事务，结束后自动提交事务。

**隐式提交**：在事务开启后，进行了对数据表结构的操作，会隐式自动提交。

**保存点**作用是使回滚更精确。

##### 读未提交 READ UNCOMMITTED
一个事务读到了其他事务还未提交的数据，会出现**脏读**。


##### 读已提交 READ COMMITTED
一个事务只能读到另一个已经提交的事务修改过的数据，会出现**幻读**/**不可重复读**。

不可重复读：前后两次读取的值是不一样的。

幻读：前后两次读取的数据个数不一致。

聚簇索引记录中包含两个必要的隐藏列，
1. `trx_id`:存放最近一次修改该记录的事务id
2. `roll_poiner`:通过该指针找到该记录修改前的信息

实现方法：版本链+ReadView。ReadView中有一个内容是m_ids，它用来记录当前系统中活跃的读写事务的事物id列表。就是MVCC多版本并发控制

##### 可重复读 REPEATABLE READ 默认的方式
一个事务先读一个数据，另一个事务对这个数据进行了修改，并且提交，先前的事物对该数据进行读取，结果与第一次读取一致。在MySQL中解决了不可重复读和幻读的问题。

再次查询时，会复用第一次查询时生成的`readView`

##### 串行化


## 锁
### 读锁和写锁
1. 读锁。共享锁。一个资源上可以加多个读锁。S锁
2. 写锁。排它锁。X锁
3. select语句无视锁

### 读操作

1. `select ... lock in share mode`对查找的数据加一个S锁
2. `select ... for update`对查找的数据加上一个X锁。

### 写操作
* DELETE
* INSERT
* UPDATE 

### 行锁
1. 行锁
2. 间隙锁